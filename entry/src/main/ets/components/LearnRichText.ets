// å®šä¹‰è¯­è¨€é¢œè‰²æ˜ å°„ç±»ï¼ˆæ·»åŠ é¸¿è’™è¯­è¨€æ”¯æŒï¼‰
class LanguageColors {
  javascript: string = '#f7df1e'
  typescript: string = '#3178c6'
  java: string = '#f89820'
  python: string = '#3776ab'
  html: string = '#e34f26'
  css: string = '#1572b6'
  json: string = '#000000'
  xml: string = '#005a9c'
  sql: string = '#336791'
  c: string = '#555555'
  cpp: string = '#f34b7d'
  php: string = '#777bb4'
  ruby: string = '#cc342d'
  go: string = '#00add8'
  swift: string = '#f05138'
  kotlin: string = '#7f52ff'
  rust: string = '#dea584'
  shell: string = '#89e051'
  yaml: string = '#cb171e'
  arkts: string = '#00aaff'  // é¸¿è’™ç‰¹æœ‰é¢œè‰²
  ets: string = '#00aaff'    // é¸¿è’™ç‰¹æœ‰é¢œè‰²
  harmony: string = '#00aaff' // é¸¿è’™ç‰¹æœ‰é¢œè‰²

  getColor(language: string): string {
    switch (language.toLowerCase()) {
      case 'javascript': return this.javascript;
      case 'typescript': return this.typescript;
      case 'java': return this.java;
      case 'python': return this.python;
      case 'html': return this.html;
      case 'css': return this.css;
      case 'json': return this.json;
      case 'xml': return this.xml;
      case 'sql': return this.sql;
      case 'c': return this.c;
      case 'cpp': return this.cpp;
      case 'php': return this.php;
      case 'ruby': return this.ruby;
      case 'go': return this.go;
      case 'swift': return this.swift;
      case 'kotlin': return this.kotlin;
      case 'rust': return this.rust;
      case 'shell': return this.shell;
      case 'bash': return this.shell;
      case 'sh': return this.shell;
      case 'yaml': return this.yaml;
      case 'yml': return this.yaml;
    // æ·»åŠ é¸¿è’™ç›¸å…³è¯­è¨€
      case 'arkts': return this.arkts;
      case 'ets': return this.ets;
      case 'harmony': return this.harmony;
      case 'hml': return this.html; // é¸¿è’™UIè¯­è¨€
      default: return '#666666';
    }
  }
}

@Component
export struct LearnRichText {
  // å¯Œæ–‡æœ¬
  @Prop richTextContent: string = ""
  private languageColors: LanguageColors = new LanguageColors()

  build() {
    Scroll() {
      RichText(this.getFormattedRichText())
        .width('100%')
    }
    .width('100%')
    .height('100%')
    .scrollBar(BarState.Auto)
    .scrollBarColor(Color.Gray)
    .scrollBarWidth(6)
  }

  private getFormattedRichText(): string {
    let content = this.richTextContent

    // å¤„ç†ä»£ç å— ```language code ```
    content = content.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match: string, lang: string, code: string): string => {
      const language = lang ? lang.toLowerCase() : 'text'
      const langColor = this.languageColors.getColor(language)
      const escapedCode = this.escapeHtml(code ? code.trim() : '')

      // ä½¿ç”¨highlight.jsè¿›è¡Œè¯­æ³•é«˜äº®ï¼Œç°è‰²èƒŒæ™¯
      return `<div style="margin: 20px 0; background: #f0f0f0; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
        ${lang ? `<div style="background-color: ${langColor}; color: white; padding: 8px 16px; font-size: 13px; font-weight: 500; display: flex; align-items: center;">
          <span>${lang}</span>
          <span style="margin-left: auto; font-size: 11px; opacity: 0.7;">${language}</span>
        </div>` : ''}
        <pre style="margin: 0; padding: 16px; font-family: 'Fira Code', 'SF Mono', monospace; font-size: 14px; line-height: 1.5; color: #333; overflow-x: auto; background: #f0f0f0 !important; border: none !important;">
          <code class="hljs language-${language}">${escapedCode}</code>
        </pre>
      </div>`
    })

    // ä¼˜åŒ–è¡Œå†…ä»£ç 
    content = content.replace(/`([^`\n]+)`/g, '<code style="background: #f1f1f1; color: #e45649; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 13px; border: 1px solid #e1e1e1;">$1</code>')

    // ä¼˜åŒ–æ ‡é¢˜é—´è·
    content = content.replace(/^# (.*$)/gm, '<h1 style="color: #2c3e50; font-size: 26px; font-weight: 700; margin: 32px 0 20px; padding-bottom: 12px; border-bottom: 2px solid #3498db;">$1</h1>')
    content = content.replace(/^## (.*$)/gm, '<h2 style="color: #34495e; font-size: 22px; font-weight: 600; margin: 28px 0 18px; padding-bottom: 8px; border-bottom: 1px solid #3498db;">$1</h2>')
    content = content.replace(/^### (.*$)/gm, '<h3 style="color: #2c3e50; font-size: 19px; font-weight: 600; margin: 24px 0 16px;">$1</h3>')
    content = content.replace(/^#### (.*$)/gm, '<h4 style="color: #2c3e50; font-size: 17px; font-weight: 600; margin: 22px 0 14px;">$1</h4>')

    // å¤„ç†ç²—ä½“ **text** æˆ– __text__
    content = content.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 700; color: #2c3e50; background: linear-gradient(transparent 60%, rgba(52, 152, 219, 0.2) 40%);">$1</strong>')
    content = content.replace(/__(.*?)__/g, '<strong style="font-weight: 700; color: #2c3e50; background: linear-gradient(transparent 60%, rgba(52, 152, 219, 0.2) 40%);">$1</strong>')

    // å¤„ç†æ–œä½“ *text* æˆ– _text_
    content = content.replace(/(?<!\*)\*([^*\n]+)\*(?!\*)/g, '<em style="font-style: italic; color: #7f8c8d; font-weight: 500;">$1</em>')
    content = content.replace(/(?<!_)_([^_\n]+)_(?!_)/g, '<em style="font-style: italic; color: #7f8c8d; font-weight: 500;">$1</em>')

    // å¤„ç†åˆ é™¤çº¿ ~~text~~
    content = content.replace(/~~(.*?)~~/g, '<del style="text-decoration: line-through; color: #95a5a6; opacity: 0.8;">$1</del>')

    // å¤„ç†é“¾æ¥ [text](url)
    content = content.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" style="color: #3498db; text-decoration: none; font-weight: 500; border-bottom: 1px solid #3498db; transition: all 0.3s ease; padding-bottom: 1px;">$1</a>')

    // ä¼˜åŒ–å›¾ç‰‡æ ·å¼ - æ·»åŠ æœ€å¤§å®½åº¦é™åˆ¶
    content = content.replace(/!\[([^\]]*)\]\(([^)]+)\)/g,
      '<div style="text-align: center; margin: 24px 0;">' +
        '<img src="$2" alt="$1" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); transition: transform 0.3s ease;"/>' +
        '<div style="margin-top: 8px; font-size: 13px; color: #777; font-style: italic;">$1</div>' +
        '</div>')

    // ä¼˜åŒ–å¼•ç”¨å—
    content = content.replace(/^> (.*$)/gm, '<blockquote style="border-left: 4px solid #3498db; background: #f0f7ff; margin: 20px 0; padding: 16px 24px; color: #2c3e50; border-radius: 0 8px 8px 0; position: relative;">' +
      '<svg style="position: absolute; left: 8px; top: 8px; width: 24px; height: 24px; opacity: 0.2;" viewBox="0 0 24 24">' +
      '<path fill="currentColor" d="M6 17h3l2-4V7H5v6h3zm8 0h3l2-4V7h-6v6h3z"/>' +
      '</svg>' +
      '<div style="padding-left: 20px;">$1</div>' +
      '</blockquote>')

    // å¤„ç†æ®µè½
    content = content.replace(/\n\n+/g, '</p><p style="margin: 18px 0; line-height: 1.7; color: #444; font-size: 16px;">')
    content = content.replace(/\n/g, '<br/>')

    // ä¼˜åŒ–åˆ—è¡¨æ ·å¼
    content = content.replace(/^[\-\*] (.+)$/gm, '<li style="margin: 8px 0; padding-left: 24px; position: relative; line-height: 1.6; display: flex; align-items: flex-start;">' +
      '<span style="position: absolute; left: 0; top: 8px; width: 8px; height: 8px; background: #3498db; border-radius: 50%; margin-right: 8px;"></span>$1' +
      '</li>')
    content = content.replace(/(<li[^>]*>.*<\/li>)/s, '<ul style="margin: 16px 0; padding-left: 8px;">$1</ul>')

    // å¤„ç†æœ‰åºåˆ—è¡¨
    content = content.replace(/^\d+\. (.+)$/gm, '<li style="margin: 8px 0; padding-left: 24px; position: relative; line-height: 1.6; display: flex; align-items: flex-start;">' +
      '<span style="position: absolute; left: 0; top: 0; min-width: 20px; height: 20px; background: #3498db; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; margin-right: 8px;">${index + 1}</span>$1' +
      '</li>')
    content = content.replace(/(<li[^>]*>.*<\/li>)/s, '<ol style="margin: 16px 0; padding-left: 8px; counter-reset: item;">$1</ol>')

    // å¤„ç†è¡¨æ ¼
    content = this.processTable(content)

    // å¤„ç†æ°´å¹³åˆ†å‰²çº¿ ---
    content = content.replace(/^---+$/gm, '<hr style="border: none; height: 2px; background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); margin: 32px 0; border-radius: 2px; box-shadow: 0 2px 4px rgba(52, 152, 219, 0.2);"/>')

    // å¤„ç†é«˜äº®æ–‡æœ¬ ==text==
    content = content.replace(/==(.*?)==/g, '<mark style="background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%); color: #856404; padding: 2px 4px; border-radius: 3px; font-weight: 500;">$1</mark>')

    // å¤„ç†é”®ç›˜æŒ‰é”® [[key]]
    content = content.replace(/\[\[([^\]]+)\]\]/g, '<kbd style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); color: #495057; padding: 4px 8px; border-radius: 4px; font-family: monospace; font-size: 12px; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-block; margin: 0 2px;">$1</kbd>')

    // å¤„ç†è„šæ³¨ [^1]
    content = content.replace(/\[\^(\d+)\]/g, '<sup id="fnref:$1" style="font-size: 0.8em;"><a href="#fn:$1" style="text-decoration: none; color: #3498db; font-weight: bold;">$1</a></sup>')

    return `
    <html>
      <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark-dimmed.min.css">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
        <script>
          // æ³¨å†Œé¸¿è’™è¯­è¨€æ”¯æŒ
          hljs.registerLanguage('arkts', function(hljs) {
            return hljs.getLanguage('typescript');
          });
          hljs.registerLanguage('ets', function(hljs) {
            return hljs.getLanguage('typescript');
          });
          hljs.registerLanguage('hml', function(hljs) {
            return hljs.getLanguage('html');
          });
          hljs.highlightAll();
        </script>
        <style>
          /* ä¿æŒåŸæœ‰æ ·å¼ */
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }

          body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            font-size: 28px;//
            line-height: 1.7;
            color: #444;
            padding: 0 !important;
            background: #f5f7fa;
            -webkit-font-smoothing: antialiased;
          }

          .content-container {
            max-width: 100%;
            margin: 0;
            background: white;
            padding: 16px;        /* é€‚å½“çš„å†…è¾¹è· */
            border-radius: 0;     /* ç§»é™¤åœ†è§’ */
            box-shadow: none;     /* ç§»é™¤é˜´å½± */


            overflow: hidden;
          }
          .content-container::after {
            content: '';
            display: block;
            height: 400px;  /* æ·»åŠ 400pxçš„åº•éƒ¨ç©ºç™½ */
            width: 100%;
          }

          /* æ·»åŠ é€‰ä¸­æ–‡æœ¬çš„æ ·å¼ */
          .selected-text {
            background: #3498db !important;
            color: white !important;
          }

          .copy-button {
            position: absolute;
            top: 9px;
            right: 4px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: all 0.3s;
            z-index: 10;
            min-width: 40px;
            text-align: center;
            width: auto;
            white-space: nowrap;
          }
          .copy-button:hover {
            opacity: 1;
          }

          .copy-button.success {
            background: #27ae60;
          }

          .copy-button.error {
            background: #e74c3c;
          }

          /* AIåˆ†ææŒ‰é’®æ ·å¼ */
          .ai-analyze-button {
            position: absolute;
            top: 8px;
            right: 60px;
            background: #8e44ad;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.3s;
            z-index: 10;
          }

          .ai-analyze-button:hover {
            opacity: 1;
          }

          .ai-analyze-button.loading {
            background: #f39c12;
            opacity: 1;
          }

          .ai-analyze-button.success {
            background: #27ae60;
          }

          .ai-analyze-button.error {
            background: #e74c3c;
          }

          /* APIå¯†é’¥è¾“å…¥å¼¹çª—æ ·å¼ */
          .api-key-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          }

          .api-key-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          }

          .api-key-modal h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
          }

          .api-key-modal p {
            color: #7f8c8d;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
          }

          .api-key-modal input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 20px;
            font-family: monospace;
          }

          .api-key-modal input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
          }

          .api-key-modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
          }

          .api-key-modal button {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
          }

          .api-key-modal .cancel-btn {
            background: #95a5a6;
            color: white;
          }

          .api-key-modal .cancel-btn:hover {
            background: #7f8c8d;
          }

          .api-key-modal .confirm-btn {
            background: #3498db;
            color: white;
          }

          .api-key-modal .confirm-btn:hover {
            background: #2980b9;
          }

          /* AIåˆ†æç»“æœå¼¹çª—æ ·å¼ */
          .ai-result-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
          }

          .ai-result-modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          }

          .ai-result-modal h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
          }

          .ai-result-modal .ai-icon {
            width: 24px;
            height: 24px;
            background: #8e44ad;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
          }

          .ai-result-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: #2c3e50;
            border-left: 4px solid #8e44ad;
          }

          .ai-result-modal button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            float: right;
          }

          .ai-result-modal button:hover {
            background: #2980b9;
          }
          /* å­—ä½“å¤§å°æ§åˆ¶æŒ‰é’®æ ·å¼ */
          .font-size-control {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            font-size: 14px;
            color: #333;
          }

          .font-size-control button {
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.3s;
          }

          .font-size-control button:hover {
            background: #2980b9;
          }

          .font-size-control .size-display {
            background: #f5f5f5;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #666;
            min-width: 40px;
            text-align: center;
          }

          /* å…¶ä»–æ ·å¼ä¿æŒä¸å˜... */
        </style>
      </head>
      <body>
      <div class="font-size-control">
  <label>å­—ä½“å¤§å°ï¼š</label>
  <button onclick="decreaseFontSize()">A-</button>
  <span class="size-display" id="fontSizeDisplay">16px</span>
  <button onclick="increaseFontSize()">A+</button>
</div>
        <div class="content-container">
          ${content}
        </div>

        <script>
        // å­—ä½“å¤§å°æ§åˆ¶åŠŸèƒ½
let currentFontSize =28 ;

// åœ¨ç°æœ‰çš„ updateFontSize() å‡½æ•°ä¸­æ·»åŠ ä»¥ä¸‹ä»£ç 
// å°†åŸæ¥çš„ updateFontSize() å‡½æ•°æ›¿æ¢ä¸ºï¼š

// ä¼˜åŒ–åçš„ updateFontSize() å‡½æ•°
function updateFontSize() {
  document.body.style.fontSize = currentFontSize + 'px';
  document.getElementById('fontSizeDisplay').textContent = currentFontSize + 'px';

  // æ”¹è¿›çš„æŒ‰é’®ç¼©æ”¾æ¯”ä¾‹è®¡ç®—ï¼ˆæ›´å¹³æ»‘çš„è¿‡æ¸¡ï¼‰
  const baseSize = 20; // åŸºå‡†å­—ä½“å¤§å°
  const minScale = 0.6; // æœ€å°ç¼©æ”¾æ¯”ä¾‹
  const maxScale = 1.8; // æœ€å¤§ç¼©æ”¾æ¯”ä¾‹

  // ä½¿ç”¨æ›´å¹³æ»‘çš„ç¼©æ”¾æ›²çº¿
  let scale;
  if (currentFontSize <= baseSize) {
    // å°äºåŸºå‡†æ—¶çº¿æ€§ç¼©æ”¾
    scale = minScale + (1 - minScale) * (currentFontSize / baseSize);
  } else {
    // å¤§äºåŸºå‡†æ—¶ä½¿ç”¨å¹³æ–¹æ ¹ç¼©æ”¾ï¼Œå˜åŒ–æ›´å¹³ç¼“
    const ratio = Math.sqrt((currentFontSize - baseSize) / baseSize);
    scale = 1 + ratio * (maxScale - 1);
  }

  scale = Math.max(minScale, Math.min(maxScale, scale));

  // åŒæ­¥è°ƒæ•´æ‰€æœ‰æŒ‰é’®å’Œæ§ä»¶çš„å¤§å°
  const elements = [
    '.copy-button',
    '.ai-analyze-button',
    '.ai-model-select',
    '.font-size-control button',
    '.font-size-control .size-display'
  ];

  elements.forEach(selector => {
    document.querySelectorAll(selector).forEach(el => {
      el.style.fontSize = (12 * scale) + 'px';
      el.style.padding = (4 * scale) + 'px ' + (8 * scale) + 'px';
    });
  });

  // ç‰¹æ®Šå¤„ç†font-size-controlå®¹å™¨
  const fontControl = document.querySelector('.font-size-control');
  if (fontControl) {
    fontControl.style.fontSize = (14 * scale) + 'px';
    fontControl.style.padding = (8 * scale) + 'px ' + (12 * scale) + 'px';
  }

  // é‡æ–°è°ƒæ•´æŒ‰é’®ä½ç½®
  document.querySelectorAll('.copy-button').forEach(btn => {
    btn.style.right = (4 * scale) + 'px';
    btn.style.top = (8 * scale) + 'px';
  });

  // å¤„ç†æ¯ä¸ªä»£ç å—çš„å¸ƒå±€
  document.querySelectorAll('pre').forEach(pre => {
    const copyBtn = pre.querySelector('.copy-button');
    const aiContainer = pre.querySelector('div[style*="position: absolute"]');

    if (copyBtn && aiContainer) {
      const copyBtnWidth = copyBtn.offsetWidth || (40 * scale);
      const gap = 8 * scale;
      aiContainer.style.right = (copyBtnWidth + gap + 4 * scale) + 'px';
      aiContainer.style.top = (8 * scale) + 'px';
    }

    // ä¿®å¤æŒ‰é’®é®æŒ¡é—®é¢˜ï¼šå‡†ç¡®è®¡ç®—æŒ‰é’®åŒºåŸŸé«˜åº¦
    let maxButtonHeight = 0;

    // è®¡ç®—å¤åˆ¶æŒ‰é’®çš„å®é™…é«˜åº¦
    if (copyBtn) {
      const copyBtnRect = copyBtn.getBoundingClientRect();
      const copyBtnBottom = copyBtn.offsetTop + copyBtnRect.height;
      maxButtonHeight = Math.max(maxButtonHeight, copyBtnBottom);
    }

    // è®¡ç®—AIæŒ‰é’®å®¹å™¨çš„å®é™…é«˜åº¦
    if (aiContainer) {
      const aiRect = aiContainer.getBoundingClientRect();
      const aiBottom = aiContainer.offsetTop + aiRect.height;
      maxButtonHeight = Math.max(maxButtonHeight, aiBottom);
    }

    // è®¾ç½®è¶³å¤Ÿçš„åº•éƒ¨è¾¹è·ï¼Œç¡®ä¿æŒ‰é’®ä¸é®æŒ¡åç»­å†…å®¹
    const preRect = pre.getBoundingClientRect();
    const preHeight = preRect.height;

    // å¦‚æœæŒ‰é’®è¶…å‡ºäº†ä»£ç å—çš„é«˜åº¦ï¼Œå¢åŠ ç›¸åº”çš„è¾¹è·
    if (maxButtonHeight > preHeight) {
      const extraMargin = maxButtonHeight - preHeight + 10; // é¢å¤–10pxé—´è·
      pre.style.marginBottom = (20 + extraMargin) + 'px';
    } else {
      // ä¿æŒé»˜è®¤è¾¹è·
      pre.style.marginBottom = '20px';
    }
  });

  // å»¶è¿Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œç¡®ä¿DOMæ›´æ–°å®Œæˆåå†æ¬¡è°ƒæ•´
  setTimeout(() => {
    document.querySelectorAll('pre').forEach(pre => {
      const copyBtn = pre.querySelector('.copy-button');
      const aiContainer = pre.querySelector('div[style*="position: absolute"]');

      if (copyBtn || aiContainer) {
        let maxButtonBottom = 0;

        if (copyBtn) {
          const rect = copyBtn.getBoundingClientRect();
          const preRect = pre.getBoundingClientRect();
          const relativeBottom = (rect.bottom - preRect.top);
          maxButtonBottom = Math.max(maxButtonBottom, relativeBottom);
        }

        if (aiContainer) {
          const rect = aiContainer.getBoundingClientRect();
          const preRect = pre.getBoundingClientRect();
          const relativeBottom = (rect.bottom - preRect.top);
          maxButtonBottom = Math.max(maxButtonBottom, relativeBottom);
        }

        // å¦‚æœæŒ‰é’®è¶…å‡ºä»£ç å—ï¼Œè°ƒæ•´è¾¹è·
        const preHeight = pre.getBoundingClientRect().height;
        if (maxButtonBottom > preHeight) {
          const extraMargin = maxButtonBottom - preHeight + 10;
          pre.style.marginBottom = (20 + extraMargin) + 'px';
        }
      }
    });
  }, 100);
}

function increaseFontSize() {
  if (currentFontSize < 80) {
    currentFontSize += 2;
    updateFontSize();
  }
}

function decreaseFontSize() {
  if (currentFontSize > 12) {
    currentFontSize -= 2;
    updateFontSize();
  }
}
          // åˆ›å»ºAIåˆ†ææŒ‰é’®
          document.querySelectorAll('pre').forEach(pre => {
            // ç¡®ä¿åªæ·»åŠ ä¸€æ¬¡æŒ‰é’®
            if (pre.querySelector('.ai-analyze-button')) return;

            // åˆ›å»ºå®¹å™¨
            const buttonContainer = document.createElement('div');
            buttonContainer.style.position = 'absolute';
            buttonContainer.style.top = '8px';
            buttonContainer.style.right = '65px';
            buttonContainer.style.display = 'flex';
            buttonContainer.style.alignItems = 'center';
            buttonContainer.style.gap = '5px';
            buttonContainer.style.zIndex = '10';

            // åˆ›å»ºAIæ¨¡å‹é€‰æ‹©ä¸‹æ‹‰åˆ—è¡¨
            const modelSelect = document.createElement('select');
            modelSelect.className = 'ai-model-select';
            modelSelect.style.background = '#34495e';
            modelSelect.style.color = 'white';
            modelSelect.style.border = 'none';
            modelSelect.style.borderRadius = '4px';
            modelSelect.style.padding = '4px 8px';
            modelSelect.style.fontSize = '12px';
            modelSelect.style.cursor = 'pointer';
            modelSelect.style.opacity = '0.8';
            modelSelect.style.transition = 'opacity 0.3s';



            // æ·»åŠ é€‰é¡¹
            const models = [
              { value: 'gpt-3.5-turbo', label: 'GPT-3.5' },
              { value: 'gpt-4o-mini', label: 'GPT-4o-mini' },
              { value: 'gpt-4o', label: 'GPT-4o' },
              { value: 'deepseek-chat', label: 'DeepSeek' }
            ];

            models.forEach(model => {
              const option = document.createElement('option');
              option.value = model.value;
              option.textContent = model.label;
              modelSelect.appendChild(option);
            });

            // é¼ æ ‡æ‚¬åœæ•ˆæœ
            modelSelect.addEventListener('mouseenter', () => {
              modelSelect.style.opacity = '1';
            });

            modelSelect.addEventListener('mouseleave', () => {
              modelSelect.style.opacity = '0.8';
            });

            // åˆ›å»ºAIåˆ†ææŒ‰é’®
            const aiButton = document.createElement('button');
            aiButton.innerHTML = 'AIåˆ†æ';
            aiButton.className = 'ai-analyze-button';
            aiButton.style.position = 'static'; // æ”¹ä¸ºç›¸å¯¹å®šä½
            aiButton.style.top = 'auto';
            aiButton.style.right = 'auto';

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            aiButton.addEventListener('click', (e) => {
              e.preventDefault();
              e.stopPropagation();

              const code = pre.querySelector('code');
              if (code) {
                const text = code.innerText || code.textContent;
                const selectedModel = modelSelect.value;

                // å…³é”®ï¼šä»ä»£ç å—ç±»åè·å–è¯­è¨€ç±»å‹
                const classList = code.className.split(/\s+/);
                let language = 'text';
                for (let cls of classList) {
                  if (cls.startsWith('language-')) {
                    language = cls.replace('language-', '');
                    break;
                  }
                }

                analyzeCode(text, language, aiButton, selectedModel);
              }
            });

            // å°†é€‰æ‹©å™¨å’ŒæŒ‰é’®æ·»åŠ åˆ°å®¹å™¨
            buttonContainer.appendChild(modelSelect);
            buttonContainer.appendChild(aiButton);

            pre.style.position = 'relative';
            pre.appendChild(buttonContainer);
            pre.querySelector('code').style.paddingTop = '60px';
          });

          // APIå¯†é’¥å­˜å‚¨ï¼ˆå†…å­˜ä¸­ï¼‰
          let apiKey = null;


          // æ˜¾ç¤ºAPIå¯†é’¥è¾“å…¥å¼¹çª—
          function showApiKeyModal(callback) {
            const modal = document.createElement('div');
            modal.className = 'api-key-modal';
            modal.innerHTML = \`
              <div class="api-key-modal-content">
                <h3>ğŸ¤– AIä»£ç åˆ†æ</h3>
                <p>é¦–æ¬¡ä½¿ç”¨éœ€è¦è¾“å…¥ChatGPT APIå¯†é’¥ã€‚å¯†é’¥ä»…å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå…³é—­é¡µé¢åä¼šæ¸…é™¤ã€‚</p>
                <input type="text" id="apiKeyInput" placeholder="è¯·è¾“å…¥æ‚¨çš„ChatGPT APIå¯†é’¥ (sk-...)" />
                <div class="api-key-modal-buttons">
                  <button class="cancel-btn" onclick="closeApiKeyModal()">å–æ¶ˆ</button>
                  <button class="confirm-btn" onclick="saveApiKey()">ç¡®è®¤</button>
                </div>
              </div>
            \`;

            document.body.appendChild(modal);

            // èšç„¦è¾“å…¥æ¡†
            setTimeout(() => {
              document.getElementById('apiKeyInput').focus();
            }, 100);

            // å›è½¦é”®ç¡®è®¤
            document.getElementById('apiKeyInput').addEventListener('keypress', (e) => {
              if (e.key === 'Enter') {
                saveApiKey();
              }
            });

            // å­˜å‚¨å›è°ƒå‡½æ•°
            window.apiKeyCallback = callback;
          }

          // å…³é—­APIå¯†é’¥å¼¹çª—
          function closeApiKeyModal() {
            const modal = document.querySelector('.api-key-modal');
            if (modal) {
              modal.remove();
            }
          }

          // ä¿å­˜APIå¯†é’¥
          function saveApiKey() {
            const input = document.getElementById('apiKeyInput');
            const key = input.value.trim();

            if (!key) {
              alert('è¯·è¾“å…¥APIå¯†é’¥');
              return;
            }

            if (!key.startsWith('sk-')) {
              alert('APIå¯†é’¥æ ¼å¼ä¸æ­£ç¡®ï¼Œåº”è¯¥ä»¥ sk- å¼€å¤´');
              return;
            }

            apiKey = key;
            closeApiKeyModal();

            // æ‰§è¡Œå›è°ƒå‡½æ•°
            if (window.apiKeyCallback) {
              window.apiKeyCallback();
              window.apiKeyCallback = null;
            }
          }

          // æ˜¾ç¤ºAIåˆ†æç»“æœå¼¹çª—
          function showAiResultModal(result) {
            const modal = document.createElement('div');
            modal.className = 'ai-result-modal';
            modal.innerHTML = \`
              <div class="ai-result-modal-content">
                <h3>
                  <span class="ai-icon">AI</span>
                  ä»£ç åˆ†æç»“æœ
                </h3>
                <div class="ai-result-content">
                  \${result.replace(/\\n/g, '<br>')}
                </div>
                <button onclick="closeAiResultModal()">å…³é—­</button>
              </div>
            \`;

            document.body.appendChild(modal);

            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', (e) => {
              if (e.target === modal) {
                closeAiResultModal();
              }
            });
          }

          // å…³é—­AIåˆ†æç»“æœå¼¹çª—
          function closeAiResultModal() {
            const modal = document.querySelector('.ai-result-modal');
            if (modal) {
              modal.remove();
            }
          }

          // AIåˆ†æä»£ç  - ä¿®å¤åçš„é€»è¾‘
          async function analyzeCode(code, language, button, model = 'gpt-3.5-turbo') {
            if (!apiKey) {
              showApiKeyModal(() => {
                analyzeCode(code, language, button, model);
              });
              return;
            }

            button.innerHTML = 'åˆ†æä¸­...';
            button.classList.add('loading');

            try {
              const prompt = \`è¯·åˆ†æä»¥ä¸‹\${language}ä»£ç è¿›è¡Œå…¨é¢åˆ†æï¼Œè¦æ±‚è¯¦å°½ã€ä¸“ä¸šï¼Œå†…å®¹åŒ…æ‹¬ä½†ä¸é™äºä»¥ä¸‹å‡ ä¸ªæ–¹é¢ï¼š
1. ã€åŠŸèƒ½æ¦‚è¿°ã€‘ï¼šè¯´æ˜ä»£ç çš„æ•´ä½“åŠŸèƒ½å’Œç”¨é€”ã€‚
2. ã€æ ¸å¿ƒé€»è¾‘è§£æã€‘ï¼šé€æ­¥è§£æä»£ç çš„ä¸»è¦æµç¨‹ã€å…³é”®å‡½æ•°å’Œæ ¸å¿ƒç®—æ³•ã€‚
3. ã€è®¾è®¡äº®ç‚¹ã€‘ï¼šæŒ‡å‡ºä»£ç ä¸­å€¼å¾—å­¦ä¹ æˆ–å€Ÿé‰´çš„è®¾è®¡æ€è·¯ã€ç»“æ„ä¼˜åŒ–æˆ–è¯­æ³•æŠ€å·§ã€‚
4. ã€æ½œåœ¨é—®é¢˜ã€‘ï¼šåˆ†æå¯èƒ½å­˜åœ¨çš„é€»è¾‘ç¼ºé™·ã€è¾¹ç•Œé—®é¢˜ã€æ€§èƒ½ç“¶é¢ˆæˆ–å®‰å…¨éšæ‚£ã€‚
5. ã€æ”¹è¿›å»ºè®®ä¸ç¤ºä¾‹ã€‘ï¼šæå‡ºå¯è¡Œçš„ä¼˜åŒ–å»ºè®®ï¼Œå¹¶é™„ä¸Šå…·ä½“ä»£ç ç¤ºä¾‹ã€‚
è¯·ç”¨æ¡ç†æ¸…æ™°ã€åˆ†æ®µæ˜ç¡®çš„æ–¹å¼è¾“å‡ºåˆ†æç»“æœã€‚
ç›´æ¥è¿”å›HTMLä»£ç ï¼Œä¸è¦ç”¨markdownæ ¼å¼
ä½¿ç”¨ä»¥ä¸‹HTMLæ ‡ç­¾å’Œæ ·å¼ï¼š
   - æ ‡é¢˜ç”¨ <h3 style="color: #2c3e50; margin: 20px 0 12px; font-size: 18px; font-weight: 600;">
   - æ®µè½ç”¨ <p style="margin: 12px 0; line-height: 1.6; color: #444;">
   - ä»£ç å—ç”¨ <pre style="background: #f6f8fa; padding: 16px; border-radius: 6px; margin: 16px 0; overflow-x: auto; border: 1px solid #e1e4e8;"><code style="font-family: 'SFMono-Regular', Consolas, monospace; font-size: 14px; color: #24292e;">[ä»£ç å†…å®¹]</code></pre>
   - è¡Œå†…ä»£ç ç”¨ <code style="background: #f6f8fa; color: #d73a49; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">
   - åˆ—è¡¨ç”¨ <ul style="margin: 12px 0; padding-left: 20px;"><li style="margin: 6px 0; line-height: 1.5;">
   - é‡ç‚¹æ–‡å­—ç”¨ <strong style="font-weight: 600; color: #2c3e50;">
   - æç¤ºæ¡†ç”¨ <div style="background: #e8f4f8; border-left: 4px solid #3498db; padding: 12px 16px; margin: 16px 0; border-radius: 4px;">
ç¡®ä¿HTMLæ ¼å¼æ­£ç¡®ï¼Œæ‰€æœ‰æ ‡ç­¾éƒ½è¦é—­åˆ
ä»£ç ï¼š
\${code}\`;

              const response = await fetch('https://api.chatanywhere.tech/v1/chat/completions', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': \`Bearer \${apiKey}\`
                },
                body: JSON.stringify({
                  model: model, // ä½¿ç”¨é€‰æ‹©çš„æ¨¡å‹
                  messages: [
                    {
                      role: 'user',
                      content: prompt
                    }
                  ],
                  max_tokens: 1000,
                  temperature: 0.7
                })
              });

              if (!response.ok) {
                throw new Error(\`APIè¯·æ±‚å¤±è´¥: \${response.status}\`);
              }

              const data = await response.json();
              const result = data.choices[0].message.content;

              showAiResultModal(result);

              button.innerHTML = 'åˆ†æå®Œæˆ';
              button.classList.remove('loading');
              button.classList.add('success');

              setTimeout(() => {
                button.innerHTML = 'AIåˆ†æ';
                button.classList.remove('success');
              }, 2000);

            } catch (error) {
              console.error('AIåˆ†æå¤±è´¥:', error);

              let errorMessage = 'åˆ†æå¤±è´¥';
              if (error.message.includes('401')) {
                errorMessage = 'APIå¯†é’¥æ— æ•ˆ';
                apiKey = null; // æ¸…é™¤æ— æ•ˆå¯†é’¥
              } else if (error.message.includes('429')) {
                errorMessage = 'è¯·æ±‚è¿‡äºé¢‘ç¹';
              } else if (error.message.includes('insufficient_quota')) {
                errorMessage = 'APIé…é¢ä¸è¶³';
              }

              button.innerHTML = errorMessage;
              button.classList.remove('loading');
              button.classList.add('error');

              setTimeout(() => {
                button.innerHTML = 'AIåˆ†æ';
                button.classList.remove('error');
              }, 3000);
            }
          }
          // æ”¹è¿›çš„å¤åˆ¶åŠŸèƒ½ - å¤šç§æ–¹æ¡ˆå…¼å®¹
          function copyToClipboard(text, button) {
            // æ–¹æ¡ˆ1: å°è¯•ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
              navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(button);
              }).catch(() => {
                // å¦‚æœå¤±è´¥ï¼Œå°è¯•ä¼ ç»Ÿæ–¹æ³•
                fallbackCopyTextToClipboard(text, button);
              });
            } else {
              // æ–¹æ¡ˆ2: ä¼ ç»Ÿçš„æ–‡æœ¬é€‰æ‹©å¤åˆ¶æ–¹æ³•
              fallbackCopyTextToClipboard(text, button);
            }
          }

          function fallbackCopyTextToClipboard(text, button) {
            // åˆ›å»ºä¸´æ—¶çš„textareaå…ƒç´ 
            const textArea = document.createElement('textarea');
            textArea.value = text;
            textArea.style.position = 'fixed';
            textArea.style.left = '-999999px';
            textArea.style.top = '-999999px';
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
              // å°è¯•æ‰§è¡Œå¤åˆ¶å‘½ä»¤
              const successful = document.execCommand('copy');
              if (successful) {
                showCopySuccess(button);
              } else {
                showCopyError(button);
              }
            } catch (err) {
              console.error('å¤åˆ¶å¤±è´¥:', err);
              showCopyError(button);
            }

            document.body.removeChild(textArea);
          }

          function showCopySuccess(button) {
            button.innerHTML = 'å·²å¤åˆ¶!';
            button.classList.add('success');
            setTimeout(() => {
              button.innerHTML = 'å¤åˆ¶';
              button.classList.remove('success');
            }, 2000);
          }

          function showCopyError(button) {
            button.innerHTML = 'é•¿æŒ‰é€‰æ‹©';
            button.classList.add('error');
            setTimeout(() => {
              button.innerHTML = 'å¤åˆ¶';
              button.classList.remove('error');
            }, 3000);
          }

          // åˆå§‹åŒ–å¤åˆ¶æŒ‰é’®
          document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('pre').forEach(pre => {
              const button = document.createElement('button');
              button.innerHTML = 'å¤åˆ¶';
              button.className = 'copy-button';

              button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();

                const code = pre.querySelector('code');
                if (code) {
                  const text = code.innerText || code.textContent;
                  copyToClipboard(text, button);
                }
              });

              // æ·»åŠ é•¿æŒ‰é€‰æ‹©åŠŸèƒ½ï¼ˆç§»åŠ¨ç«¯å‹å¥½ï¼‰
              let longPressTimer;
              button.addEventListener('touchstart', (e) => {
                longPressTimer = setTimeout(() => {
                  const code = pre.querySelector('code');
                  if (code) {
                    // é€‰ä¸­ä»£ç æ–‡æœ¬
                    const selection = window.getSelection();
                    const range = document.createRange();
                    range.selectNodeContents(code);
                    selection.removeAllRanges();
                    selection.addRange(range);

                    button.innerHTML = 'å·²é€‰ä¸­';
                    button.classList.add('success');
                    setTimeout(() => {
                      button.innerHTML = 'å¤åˆ¶';
                      button.classList.remove('success');
                    }, 2000);
                  }
                }, 1000);
              });

              button.addEventListener('touchend', () => {
                clearTimeout(longPressTimer);
              });

              pre.style.position = 'relative';
              pre.appendChild(button);
            });

            // ç¡®ä¿ä»£ç å—æ ·å¼ä¸€è‡´
            document.querySelectorAll('pre, pre code').forEach(el => {
              el.style.backgroundColor = '#f0f0f0';
              el.style.border = 'none';
            });

            // å›¾ç‰‡åŠ è½½ä¼˜åŒ–
            document.querySelectorAll('img').forEach(img => {
              // ç¡®ä¿å›¾ç‰‡ä¸è¶…å‡ºå®¹å™¨
              img.style.maxWidth = '100%';
              img.style.width = 'auto';
              img.style.height = 'auto';
              img.style.display = 'block';
              img.style.margin = '0 auto';
              img.style.boxSizing = 'border-box';

              // å›¾ç‰‡åŠ è½½å¤±è´¥å¤„ç†
              img.onerror = function() {
                this.style.display = 'none';
                const parent = this.parentElement;
                if (parent) {
                  parent.innerHTML = '<div style="padding: 20px; text-align: center; color: #999; border: 2px dashed #ddd; border-radius: 8px;">å›¾ç‰‡åŠ è½½å¤±è´¥</div>';
                }
              };

              // å›¾ç‰‡åŠ è½½æˆåŠŸåç¡®ä¿å°ºå¯¸æ­£ç¡®
              img.onload = function() {
                this.style.maxWidth = '100%';
                this.style.width = 'auto';
                this.style.height = 'auto';
              };
            });
          });
        </script>
      </body>
    </html>
  `
  }

  // å¤„ç†è¡¨æ ¼
  private processTable(content: string): string {
    const tableRegex = /(\|[^\n]+\|\n)+/g
    return content.replace(tableRegex, (match: string): string => {
      const rows = match.trim().split('\n')
      if (rows.length < 2) return match

      let tableHtml = '<table style="width: 100%; margin: 24px 0; border-collapse: collapse;">'

      rows.forEach((row: string, index: number) => {
        if (index === 1 && row.includes('---')) return // è·³è¿‡åˆ†éš”è¡Œ

        const cells = row.split('|').filter((cell: string) => cell.trim() !== '')
        const tag = index === 0 ? 'th' : 'td'

        tableHtml += '<tr>'
        cells.forEach((cell: string) => {
          tableHtml += `<${tag} style="padding: 12px 16px; border: 1px solid #eee; text-align: left;">${cell.trim()}</${tag}>`
        })
        tableHtml += '</tr>'
      })

      tableHtml += '</table>'
      return tableHtml
    })
  }


  // HTMLè½¬ä¹‰
  private escapeHtml(text: string): string {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
  }
}